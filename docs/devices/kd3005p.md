# KD3005P Device

The KD3005P is a Korad/RND laboratory bench power supply with 30V/5A output capability. This driver provides full control and monitoring through MQTT, MCP, and GUI interfaces.

## Overview

The KD3005P driver provides:
- Full voltage and current control
- Output enable/disable
- Real-time voltage and current readings
- Serial communication over USB
- Security limit enforcement
- Reliable state management

## Specifications

### Hardware Capabilities

- **Voltage Range**: 0-30V
- **Current Range**: 0-5A
- **Maximum Power**: 150W
- **Voltage Resolution**: 10mV
- **Current Resolution**: 1mA
- **Connection**: USB (virtual COM port)

### Manufacturer Information

- **Models**: Korad KD3005P, RND 320-KD3005P
- **Protocol**: Korad proprietary serial protocol
- **Baud Rate**: 9600 (default)

## Configuration

Configure the KD3005P in your configuration file:

```json
{
  "devices": {
    "lab_psu": {
      "model": "kd3005p",
      "description": "Laboratory bench power supply",
      "security_min_voltage": 0.0,
      "security_max_voltage": 30.0,
      "security_min_current": 0.0,
      "security_max_current": 5.0
    }
  }
}
```

### Configuration Parameters

- **model** (required): Must be `"kd3005p"`
- **description** (optional): Human-readable description
- **security_min_voltage** (optional): Minimum allowed voltage (default: 0.0V)
- **security_max_voltage** (optional): Maximum allowed voltage (default: 30.0V)
- **security_min_current** (optional): Minimum allowed current (default: 0.0A)
- **security_max_current** (optional): Maximum allowed current (default: 5.0A)

?> **Important**: Security limits should be set according to your specific use case to prevent damage to connected circuits.

## USB Connection

### Device Detection

The driver automatically detects and connects to KD3005P devices via USB:

1. Device appears as a virtual COM port
2. Driver scans available ports
3. Identifies KD3005P by device signature
4. Establishes serial connection

### Linux Setup

On Linux, you may need to configure permissions:

1. **Add user to dialout group**:
   ```bash
   sudo usermod -a -G dialout $USER
   ```
   
2. **Log out and log back in** for the change to take effect

3. **Verify device is detected**:
   ```bash
   ls -l /dev/ttyUSB* /dev/ttyACM*
   ```

4. **Optional: Create udev rule** for consistent device naming:
   ```bash
   # Create file: /etc/udev/rules.d/99-kd3005p.rules
   SUBSYSTEM=="tty", ATTRS{idVendor}=="0416", ATTRS{idProduct}=="5011", SYMLINK+="kd3005p", MODE="0666"
   ```

### macOS Setup

1. Device should be automatically detected as `/dev/tty.usbserial-*`
2. No special permissions typically needed
3. Verify with: `ls /dev/tty.usb*`

### Windows Setup

1. Device appears as COM port (e.g., COM3, COM4)
2. May require CH340/CH341 USB driver installation
3. Check Device Manager to verify the port number

## Capabilities

### Voltage Control

- **Range**: 0V to 30V
- **Resolution**: 10mV (0.01V)
- **Accuracy**: ±0.5% + 10mV
- **Response Time**: ~100ms

**Usage**:
```bash
# Set voltage to 5.00V
mosquitto_pub -h 127.0.0.1 -t "power-supply/lab_psu/control/voltage/cmd" -m "5.0"

# Set voltage to 12.34V
mosquitto_pub -h 127.0.0.1 -t "power-supply/lab_psu/control/voltage/cmd" -m "12.34"
```

### Current Control

- **Range**: 0A to 5A
- **Resolution**: 1mA (0.001A)
- **Accuracy**: ±1% + 10mA
- **Response Time**: ~100ms

**Usage**:
```bash
# Set current limit to 1.000A
mosquitto_pub -h 127.0.0.1 -t "power-supply/lab_psu/control/current/cmd" -m "1.0"

# Set current limit to 0.500A
mosquitto_pub -h 127.0.0.1 -t "power-supply/lab_psu/control/current/cmd" -m "0.5"
```

### Output Enable/Disable

- **States**: ON (enabled) / OFF (disabled)
- **Response Time**: ~50ms
- **Safety**: Output disabled on startup and errors

**Usage**:
```bash
# Enable output
mosquitto_pub -h 127.0.0.1 -t "power-supply/lab_psu/control/oe/cmd" -m "ON"

# Disable output
mosquitto_pub -h 127.0.0.1 -t "power-supply/lab_psu/control/oe/cmd" -m "OFF"
```

### Measurements

The KD3005P provides real-time voltage and current measurements:

- **Voltage Measurement**: Actual output voltage
- **Current Measurement**: Actual output current
- **Update Rate**: Configurable via MQTT topics
- **Accuracy**: Same as control accuracy

## Operating Modes

### Constant Voltage (CV) Mode

When the load draws less current than the set limit:
- Output maintains set voltage
- Current varies with load
- CV indicator lit on device

### Constant Current (CC) Mode

When the load tries to draw more than the current limit:
- Output current limited to set value
- Voltage drops below set point
- CC indicator lit on device

The driver reports the current operating mode through status topics.

## Initialization Sequence

When the driver starts:

1. **Port Detection**: Scans for available serial ports
2. **Device Identification**: Queries device ID to confirm KD3005P
3. **State Synchronization**: Reads current voltage, current, and output state
4. **Safety Check**: Ensures output is disabled
5. **MQTT Registration**: Subscribes to command topics
6. **Ready**: Publishes initial state

## Error Handling

### Communication Errors

If communication with the device fails:
- Driver attempts automatic reconnection
- Error published to error topic
- Commands are queued and retried
- GUI shows disconnected state

### Hardware Errors

If the device reports errors:
- Error message published to MQTT
- Output may be automatically disabled
- Manual intervention may be required

### Safety Timeouts

If no response from device:
- Command times out after 5 seconds
- Error logged and published
- Device state marked as unknown
- Safe defaults assumed

## Best Practices

### Power-On Sequence

Always follow this safe power-on sequence:

1. **Set current limit first** (to safe value for your circuit)
2. **Set voltage** (to desired value)
3. **Enable output**
4. **Monitor current** (ensure it's within expected range)
5. **Adjust as needed**

Example:
```bash
# Safe power-on for 5V circuit with max 1A
mosquitto_pub -h 127.0.0.1 -t "power-supply/lab_psu/control/current/cmd" -m "1.0"
mosquitto_pub -h 127.0.0.1 -t "power-supply/lab_psu/control/voltage/cmd" -m "5.0"
mosquitto_pub -h 127.0.0.1 -t "power-supply/lab_psu/control/oe/cmd" -m "ON"
```

### Power-Off Sequence

Safe power-off:

1. **Disable output**
2. **Optionally reduce voltage to 0V**

Example:
```bash
# Safe power-off
mosquitto_pub -h 127.0.0.1 -t "power-supply/lab_psu/control/oe/cmd" -m "OFF"
mosquitto_pub -h 127.0.0.1 -t "power-supply/lab_psu/control/voltage/cmd" -m "0.0"
```

### Security Limits

Configure conservative security limits:

```json
{
  "devices": {
    "lab_psu": {
      "model": "kd3005p",
      "description": "Protected for 5V circuits",
      "security_min_voltage": 0.0,
      "security_max_voltage": 5.5,
      "security_min_current": 0.0,
      "security_max_current": 2.0
    }
  }
}
```

This prevents accidental overvoltage of sensitive 5V circuits.

## Performance Considerations

### Command Rate

- **Recommended**: Maximum 10 commands/second
- **Device Limitation**: Serial communication bandwidth
- **Queueing**: Commands are queued internally

### Measurement Updates

- **Default Rate**: 1 Hz (once per second)
- **Configurable**: Via refresh_freq topics
- **Trade-off**: Higher rates increase CPU/network load

## Troubleshooting

### Device Not Detected

**Check USB connection**:
```bash
# Linux
ls -l /dev/ttyUSB* /dev/ttyACM*

# macOS
ls -l /dev/tty.usb*

# Windows - use Device Manager
```

**Check permissions** (Linux):
```bash
groups  # Should include 'dialout'
```

**Check driver logs**:
```bash
cargo run --release 2>&1 | grep -i kd3005p
```

### Commands Not Working

**Verify device name**:
- Must match exactly what's in configuration
- Case-sensitive

**Check security limits**:
- Commands outside limits are rejected
- Review configuration

**Check device state**:
- Device must be powered on
- USB cable must be connected
- Device must not be in error state

### Inconsistent Readings

**Wait for stabilization**:
- Readings may fluctuate briefly after changes
- Allow 100-200ms for settling

**Check connections**:
- Loose load connections can cause instability
- Verify all connections are secure

### Communication Timeout

**Reduce command rate**:
- Space out commands by 100ms minimum
- Don't flood the device with rapid commands

**Check USB cable**:
- Use a quality USB cable
- Avoid long cables or USB hubs if possible

**Restart device**:
- Power cycle the KD3005P
- Restart the application

## Multiple Devices

You can control multiple KD3005P units:

```json
{
  "devices": {
    "psu_1": {
      "model": "kd3005p",
      "description": "First power supply"
    },
    "psu_2": {
      "model": "kd3005p",
      "description": "Second power supply"
    }
  }
}
```

Each device:
- Has its own USB connection
- Has its own MQTT topics
- Has its own MCP endpoint
- Operates independently

## Firmware Considerations

Different firmware versions may have slight variations:
- Most KD3005P units use compatible firmware
- Some clone devices may have protocol differences
- Test thoroughly with your specific unit

## Known Limitations

- Cannot read device temperature
- No programmable output sequences
- No built-in data logging (use MQTT subscribers)
- Serial protocol is proprietary and not fully documented

## Implementation Details

The KD3005P driver uses the `ka3005p` Rust crate for hardware communication:
- Source: https://github.com/XdoctorwhoZ/ka3005p
- Implements full serial protocol
- Async operations
- Error recovery

## See Also

- [Emulator Device](emulator.md) - Virtual device for testing
- [Configuration Guide](../getting-started/configuration.md) - Device configuration
- [MQTT Interface](../interfaces/mqtt.md) - Control via MQTT
- [GUI Interface](../interfaces/gui.md) - Visual control
